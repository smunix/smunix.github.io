<!doctype html><!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]--><!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]--><!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en"> <!--<![endif]-->
<!-- Mirrored from www.fpcomplete.com/blog/2016/03/efficient-binary-serialization by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 31 Dec 2016 04:42:17 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta charset="UTF-8"><meta name="google-site-verification" content="DAcj3V2VPIWbiY2qQJaztufXD7u4kY75RlyH2zhIHsk" /><title>Efficient binary serialization :: FP Complete</title><meta name="google-site-verification" content="DAcj3V2VPIWbiY2qQJaztufXD7u4kY75RlyH2zhIHsk" /><meta name="viewport" content="width=device-width,initial-scale=1"><link href="https://www.fpcomplete.com/feed" type="application/atom+xml" rel="alternate" title="FP Complete Blog">
<link href="https://www.fpcomplete.com/feed" type="application/rss+xml" rel="alternate" title="FP Complete Blog">
<meta name="author" content="Michael Snoyman">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"><link rel="stylesheet" href="https://www.fpcomplete.com/static/css/code-highlighting.css?etag=OmhFiN9e"><link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/styles/default.min.css"><style>#social{margin:1em 0;padding:0.25em}#social > div{margin-right:1em;display:inline-block}#social{margin:1em 0;padding:0.25em}#social > div{margin-right:1em;display:inline-block}.container{font-family:"Segoe UI", Candara, "Bitstream Vera Sans", "DejaVu Sans", "Bitstream Vera Sans", "Trebuchet MS", Verdana, "Verdana Ref", sans-serif;font-size:1.1em}#twitter > div{margin-right:1em;display:inline-block}</style><!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--></head><body><nav class="navbar navbar-inverse"><div class="container"><div class="row"><div class="col-md-12"><div class="navbar-header"><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#top-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</button>
<ul class="nav navbar-nav collapse navbar-collapse" id="top-navbar"><li><a href="https://www.fpcomplete.com/"><img src="https://www.fpcomplete.com/static/fpcomplete-logo-transparent.png?etag=5QQp_9Ic" alt="FP Complete" title="FP Complete" style="max-height:100%;height:2em">
</a>
</li>
<li><a href="https://www.fpcomplete.com/blog">Blog</a>
</li>
<li><a href="https://www.fpcomplete.com/haskell">Haskell</a>
</li>
<li><a href="https://www.fpcomplete.com/devops">Devops</a>
</li>
<li><a href="https://www.fpcomplete.com/consulting">Consulting</a>
</li>
<li><a href="https://www.fpcomplete.com/training">Training</a>
</li>
<li><a href="https://www.fpcomplete.com/contact-us">Contact</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</nav>
<div class="container"><div class="row"><div class="col-md-12"><h1 itemprop="name">Efficient binary serialization</h1>
<div id="social"><div class="twitter-share"><a class="twitter-share-button" href="https://twitter.com/share" data-show-count="false">Tweet</a>
</div>
<div class="reddit"><script type="text/javascript" src="http://www.redditstatic.com/button/button1.js"></script>
</div>
<div class="linkedin"><script src="http://platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<script type="IN/Share" data-counter="right"></script>
</div>
<div class="googleplus"><script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone></g:plusone>
</div>
</div>
</div>
</div>
<div class="row"><div class="col-md-8"><p><span class="date">14 Mar 2016</span>
<span class="author"><em>Michael Snoyman</em>
</span>
</p>
<article itemprop="desc"><p><i>FP Complete has multiple openings for software and devops engineers. If you&#39;re
interested in working on Haskell, container-based deployment, build systems, or
just about anything you read about on this blog, <a href="mailto:jobs@fpcomplete.com">send us your
CV</a>.</i></p><p>We do a lot of work at FP Complete in the realm of multi-machine computing for
our customers. One of the things we need to do efficiently to get good speedups
from adding more machines is optimizing serialization. Since our multi-machine
work often revolves around scientific and mathematical computing, we primarily
need to make sure that there is efficient serialization of primitive data types
(like <code>Int64</code> and <code>Double</code>), strict/unpacked product types (e.g. <code>data Foo =
Foo !Int64 !Double</code>), and vectors of any of these.</p><p><b>For the impatient</b>: <a href="https://s3.amazonaws.com/download.fpcomplete.com/michael/serial-bench-2016-03-13.html" rel="nofollow">benchmark
results</a>
and <a href="https://github.com/fpco/serial-bench" rel="nofollow">repo</a></p><p>Not too long ago Francesco <a href="https://www.reddit.com/r/haskell/comments/44w15q/psa_if_youre_serializing_floating_point_numbers/" rel="nofollow">discovered and
reported</a>
some issues with the binary package&#39;s serialization of <code>Double</code>s. In response
to this, we internally switched over to using the cereal package instead, which
resulted in <a href="https://github.com/GaloisInc/cereal/pulls?q=is%3Apr+author%3Abitonic+is%3Aclosed" rel="nofollow">a few more performance related
PRs</a>.
However, when the FP Complete team discussed serialization, and particularly
the needs that our multi-machine computing and other client projects require,
we realized that we may have some opportunities to do better.</p><p>Both the binary and cereal packages are very featureful, and with these
features come some overhead. We actually have much simpler requirements for our
standard serialization cases, e.g.:</p><ul><li>There&#39;s no need for backwards compatible formats, since two identical
executables will be running on two machines and will need to communicate with
each other</li><li>Similarly, we don&#39;t need to have a consistent endianness for our encoding;
using host byte order will always work for our use case</li><li>Given the structure of data we work with, we will almost always have a very
cheap method of determining the serialized size of a piece of data. For
example, a vector of 50 <code>Double</code>s will be one <code>Int64</code> (to hold the length of
the vector) plus 50 * <code>sizeOf (undefined :: Double)</code>, or in other words: <code>51 * 8</code>.
By leveraging this, we can possibly do a more efficient serialization step
by allocating a buffer of exactly the correct size</li><li>We can get away with requiring that all data be in memory, since all of our
use cases require that the data be fully evaluated at once (no lazy
processing of larger-than-memory data sets)</li><li>There&#39;s no need for any kind of fancy deserialization involving backtracking</li></ul><p>With these ideas in mind, I&#39;ve spent the past few days putting together a
variety of different implementations of both encoding and decoding, and believe
that for the limited cases I just described, we can get significantly better
serialization performance.</p><h2 id="vector-somedata">Vector SomeData</h2><p>The benchmarks I&#39;ve used for this experiment focus on a fairly simple encoding
and decoding test for a boxed vector of <code>SomeData</code> values. The <code>SomeData</code> type
has a single data constructor with strict fields of <code>Int64</code>, <code>Word8</code>, and
<code>Double</code>. This is a fairly good representation of the kind of data that we deal
with regularly. Serializing more complex datatypes, or more variable-length
types like a <code>ByteString</code>, are certainly supported by all of the schemes I&#39;ve
described here, but the performance impact of that has not been tested (since
it&#39;s not the main focus of our work).</p><h2 id="representations">Representations</h2><p>There are three different binary representations of the data used in this
benchmark suite:</p><ul><li><p>Simple little-endian (host-endian) serialization. In this case, the values
are serialized in exactly the same format as they are stored in memory. (This
assumes of course a little-endian architecture, which is what I did all testing
on and our target architecture in production in almost all cases.) <code>Vector</code>s
are serialized by storing the length of the <code>Vector</code> as an <code>Int64</code> followed by
each successive element from the <code>Vector</code>. This format is used by the following
functions:</p><ul><li><code>encodeSimpleRaw</code></li><li><code>encodeSimplePoke</code></li><li><code>encodeSimplePokeMonad</code></li><li><code>encodeSimplePokeRef</code></li><li><code>encodeSimplePokeRefMonad</code></li><li><code>encodeBuilderLE</code></li><li><code>decodeSimplePeek</code></li><li><code>decodeSimplePeekEx</code></li><li><code>decodeRawLE</code></li></ul></li><li><p>The big-endian format of the above. This format is used by the following
functions:</p><ul><li><code>encodeBuilderBE</code></li><li><code>encodeCereal</code></li><li><code>decodeRawBE</code></li><li><code>decodeCereal</code></li></ul></li><li><p>The binary format, used exclusively by the binary package. The special magic
in this format is that <code>Double</code>s are encoded as a pair of <code>Integer</code> and
<code>Int</code>. This is the original performance bug that Francesco found and reported
on Reddit, and which kicked off this whole analysis.</p></li></ul><p>Let&#39;s start with the benchmark results, and then do some more analysis:</p><p><img src="https://s3.amazonaws.com/download.fpcomplete.com/michael/2bt7dns.png" alt="Benchmark results"></p><p>Unsurprisingly, <code>binary</code> performed the worse by far, mainly due to its <code>Double</code>
serialization. Similarly, the big endian approaches were all slower than the
little endian approaches, though the cereal package performed significantly
worse than the raw bytestring-builder encoding and direct
ByteString/bit-shifting decoding.</p><p>Since the little endian encoding wins as far as representation, we&#39;ll spend the
rest of this approach analyzing the different trade-offs in encoding and
decoding, based on the 6 encoding and 3 decoding functions implemented and
tested here.</p><h2 id="continuation-vs-mutable-reference">Continuation vs mutable reference</h2><p>When both encoding and decoding, we need to keep track of the current offset
being written to/read from within the buffer. In the case of decoding, we also
need to have some way to fail out if the data parsed is not what we expect, or
there are insufficient bytes to consume. I tested two approaches for this:</p><ul><li><p>A continuation-based approach, where each computation is passed the next
computation to perform. That next computation takes a parameter of the
updated offset, and in the case of decoding returns a <code>Maybe</code> value to allow
for failure. This technique is used by the functions:</p><ul><li><code>encodeSimpleRaw</code></li><li><code>encodeSimplePoke</code></li><li><code>encodeSimplePokeMonad</code></li><li><code>decodeSimplePeek</code></li><li><code>decodeRawLE</code></li></ul></li><li><p>A mutable reference approach. In this case, instead of each function needing
to take an updated offset value, the value is stored in a mutable reference.
This allows the environment available to each function to be identical (i.e., a
pure <code>ReaderT</code> setup), which GHC is good at optimizing. On the other hand, GHC
also tends to do much better at optimizing code without mutable references in
it. To deal with failed decoding in this setup, we use runtime exceptions. This
technique is used by the functions:</p><ul><li><code>encodeSimplePokeRef</code></li><li><code>encodeSimplePokeRefMonad</code></li><li><code>decodeSimplePeekEx</code></li></ul></li></ul><p>As you can see from the results, the continuation based approach gave a slight
performance advantage. While this is what I would have expected, the difference
between the two was less than I had expected. Additionally, in some earlier
testing before I&#39;d added more optimization, the reference based implementation
actually outperformed the continuation based implementation. The details of
what&#39;s going on at the core level would be an interesting follow-up analysis.</p><h3 id="optimizing-the-mutable-reference">Optimizing the mutable reference</h3><p>If you dive into the code, you may be a bit surprised at how the offset
reference is represented. Instead of a more standard <code>IORef</code>, we have:</p><pre><span class='hs-keyword'>newtype</span> <span class='hs-conid'>OffsetRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OffsetRef</span>
    <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span><span class='hs-varop'>.</span><span class='hs-conid'>Unboxed</span><span class='hs-varop'>.</span><span class='hs-conid'>Mutable</span><span class='hs-varop'>.</span><span class='hs-conid'>MVector</span> <span class='hs-conid'>RealWorld</span> <span class='hs-conid'>Offset</span><span class='hs-layout'>)</span></pre><p>The idea here is to take advantage of the more efficient unboxed representation
and byte array operations provided by the vector package and GHC. This also
avoids a lot of garbage collection overhead used by the boxed nature of
<code>IORef</code>. This is the same technique leveraged by the
<a href="https://www.stackage.org/package/mutable-containers" rel="nofollow">mutable-containers</a>
package. Also, check out <a href="http://stackoverflow.com/questions/27261813/why-is-my-little-stref-int-require-allocating-gigabytes" rel="nofollow">the Stack Overflow question on the
topic</a>.</p><h2 id="storable-bit-shifting-and-bytestring-builder">Storable, bit-shifting, and bytestring-builder</h2><p>When it comes to storing primitive datatypes in a pointer, it&#39;s unsurprising to
see the <a href="http://haddock.stackage.org/lts-5.8/base-4.8.2.0/Foreign-Storable.html" rel="nofollow">Storable type
class</a>.
This class&#39;s peek and poke operations are implemented under the surface with
GHC primops. We get away with this because, in our implementation, we are
always using host byte order. By contrast, the cereal, binary, and
bytestring-builder packages need to do more direct bit-shifting, such as:</p><pre><span class='hs-definition'>word64be</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Word64</span>
<span class='hs-definition'>word64be</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span>
              <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varop'>`</span><span class='hs-conid'>SU</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span><span class='hs-varop'>`</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>`shiftL`</span> <span class='hs-num'>56</span><span class='hs-layout'>)</span> <span class='hs-varop'>.|.</span>
              <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varop'>`</span><span class='hs-conid'>SU</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span><span class='hs-varop'>`</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`shiftL`</span> <span class='hs-num'>48</span><span class='hs-layout'>)</span> <span class='hs-varop'>.|.</span>
              <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varop'>`</span><span class='hs-conid'>SU</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span><span class='hs-varop'>`</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-varop'>`shiftL`</span> <span class='hs-num'>40</span><span class='hs-layout'>)</span> <span class='hs-varop'>.|.</span>
              <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varop'>`</span><span class='hs-conid'>SU</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span><span class='hs-varop'>`</span> <span class='hs-num'>3</span><span class='hs-layout'>)</span> <span class='hs-varop'>`shiftL`</span> <span class='hs-num'>32</span><span class='hs-layout'>)</span> <span class='hs-varop'>.|.</span>
              <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varop'>`</span><span class='hs-conid'>SU</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span><span class='hs-varop'>`</span> <span class='hs-num'>4</span><span class='hs-layout'>)</span> <span class='hs-varop'>`shiftL`</span> <span class='hs-num'>24</span><span class='hs-layout'>)</span> <span class='hs-varop'>.|.</span>
              <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varop'>`</span><span class='hs-conid'>SU</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span><span class='hs-varop'>`</span> <span class='hs-num'>5</span><span class='hs-layout'>)</span> <span class='hs-varop'>`shiftL`</span> <span class='hs-num'>16</span><span class='hs-layout'>)</span> <span class='hs-varop'>.|.</span>
              <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varop'>`</span><span class='hs-conid'>SU</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span><span class='hs-varop'>`</span> <span class='hs-num'>6</span><span class='hs-layout'>)</span> <span class='hs-varop'>`shiftL`</span>  <span class='hs-num'>8</span><span class='hs-layout'>)</span> <span class='hs-varop'>.|.</span>
              <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varop'>`</span><span class='hs-conid'>SU</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span><span class='hs-varop'>`</span> <span class='hs-num'>7</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span></pre><p>Leveraging <code>Storable</code> whenever possible simplifies our codebase and makes it
more efficient. In fact, the <code>Simple</code> typeclass - used for most of our
implementations here - provides default implementations of all functions in
terms of <code>Storable</code>, so that the instances for primitive types just look like:</p><pre><span class='hs-keyword'>instance</span> <span class='hs-conid'>Simple</span> <span class='hs-conid'>Int64</span>
<span class='hs-keyword'>instance</span> <span class='hs-conid'>Simple</span> <span class='hs-conid'>Word8</span>
<span class='hs-keyword'>instance</span> <span class='hs-conid'>Simple</span> <span class='hs-conid'>Double</span></pre><h3 id="simplesize-::-either-int-a--gt-int">simpleSize :: Either Int (a -&gt; Int)</h3><p>You may be wondering: if <code>Storable</code> is so great, why not just base a
serialization library on it directly? There&#39;s one downside: it assumes that
every datatype has a fixed serialized width. While this works great for <code>Int</code>s
and the like, it fails with a <code>Vector</code>, where we need to know - at runtime -
the actual length of the <code>Vector</code> to determine its serialized size.</p><p>A naive implementation of this would look like:</p><pre><span class='hs-definition'>simpleSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span></pre><p>However, this signature implies that every type&#39;s size may change at runtime.
This would require that, when serializing a <code>Vector</code>, we always inspect every
single value, which introduces significant CPU overhead. For example, given
that the representation of a <code>Vector</code> is an 8-byte integer length plus the
sizes of all elements, this would look like:</p><pre><span class='hs-definition'>simpleSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<span class='hs-definition'>simpleSize</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>8</span> <span class='hs-varop'>+</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-varid'>simpleSize</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span></pre><p>But in the case of statically-known sizes, we&#39;d like to replace that <code>sum</code> with
a simple multiplication. To make this work, we have a slightly smarter type
signature for the size function:</p><pre><span class='hs-definition'>simpleSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>Int</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span></pre><p>If this function returns <code>Left</code>, there&#39;s no need to inspect individual values.
For <code>Right</code>, we&#39;re stuck with checking each thing. Putting this together,
here&#39;s our implementation for <code>Vector</code>s.</p><pre><span class='hs-definition'>simpleSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>Int</span> <span class='hs-layout'>(</span><span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<span class='hs-definition'>simpleSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span>
    <span class='hs-keyword'>case</span> <span class='hs-varid'>simpleSize</span> <span class='hs-keyword'>of</span>
        <span class='hs-conid'>Left</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span> <span class='hs-varop'>*</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>length</span> <span class='hs-varid'>v</span> <span class='hs-varop'>+</span> <span class='hs-num'>8</span>
        <span class='hs-conid'>Right</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-varid'>f</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-num'>8</span></pre><p>Notice how, for a <code>Vector Int64</code>, we&#39;d be able to follow the <code>Left</code> branch and
avoid the costly <code>sum</code>. This ends up giving us really cheap knowledge of the
total buffer size needed, which we take advantage of when encoding, e.g.:</p><pre><span class='hs-definition'>encodeSimpleRaw</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Simple</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ByteString</span>
<span class='hs-definition'>encodeSimpleRaw</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeCreate</span>
    <span class='hs-layout'>(</span><span class='hs-varid'>either</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varop'>$</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>simpleSize</span><span class='hs-layout'>)</span>
    <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>p</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>simpleRawPoke</span> <span class='hs-varid'>p</span> <span class='hs-num'>0</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span></pre><h2 id="monadic-vs-monoidal-interface">Monadic vs Monoidal interface</h2><p>Ever since <code>blaze-html</code> famously provided a broken <code>Monad</code> interface in the
name of performance, there&#39;s been a concern (at least by me) that providing a
proper <code>Monad</code> instance instead of just a <code>Monoid</code> instance could slow things
down. Therefore, this benchmark included encoding functions that are both
monadic (<code>encodeSimplePokeMonad</code> and <code>encodeSimplePokeRefMonad</code>) and monoidal
(<code>encodeSimplePoke</code> and <code>encodeSimplePokeRef</code>). To my surprise, they performed
nearly identically.</p><p>The monadic interface though has many advantages over a monoidal one:</p><ul><li>You can still provide a <code>Monoid</code> instance for any <code>Monad</code>, so you actually
get <i>both</i> interfaces for free</li><li>You get to use <code>do</code> notation if desired</li><li>Subjectively, I&#39;d guess that people are more used to monadic combinators
(e.g., <code>mapM_</code> vs <code>foldMap</code>).</li><li>In my testing, I found a major slowdown due to the usage of <code>foldMap</code> from
<code>Vector</code>. I&#39;m guessing this is due to a missing <code>INLINE</code> in the default
implementation of <code>foldMap</code> in <code>Data.Foldable</code>, but I haven&#39;t had a chance to
investigate yet. Again, since monadic combinators seem to be more well used,
odds are that they will also be more well optimized.</li></ul><h2 id="overall-abstraction-overhead">Overall abstraction overhead</h2><p>In addition to the nice <code>newtype</code>-wrapped monads and monoids, I implemented a
raw version of both encoding and decoding, just to see if the abstraction added
an overhead. Fortunately, this was not the case, which lets us stick with
relatively simple high-level code such as:</p><pre><span class='hs-definition'>simplePeek</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SomeData</span>
    <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>simplePeek</span>
    <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>simplePeek</span>
    <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>simplePeek</span></pre><p>instead of:</p><pre><span class='hs-definition'>readInt64</span>  <span class='hs-varid'>bs</span>  <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>bsX</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span>
<span class='hs-definition'>readWord8</span>  <span class='hs-varid'>bsX</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>bsY</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>-&gt;</span>
<span class='hs-definition'>readDouble</span> <span class='hs-varid'>bsY</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>bsZ</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
    <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeWrite</span> <span class='hs-varid'>mv</span> <span class='hs-varid'>idx</span> <span class='hs-layout'>(</span><span class='hs-conid'>SomeData</span> <span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-varid'>z</span><span class='hs-layout'>)</span>
    <span class='hs-varid'>loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>idx</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>bsZ</span></pre><h2 id="st-like-monad">ST-like monad</h2><p>If you look at <a href="http://haddock.stackage.org/lts-5.8/vector-binary-instances-0.2.3.1/src/Data-Vector-Binary.html" rel="nofollow">the implementation of the <code>Binary</code> instance for
<code>Vector</code></a>,
you&#39;ll see that it needs to resort to <code>unsafePerformIO</code>. This is because, in
order to efficiently create a <code>Vector</code>, it needs to perform mutations, but the
<code>Get</code> monad from binary does not provide any <code>ST</code> or <code>IO</code> like behavior for
mutating a buffer.</p><p>Since we&#39;re designing a new decoding interface from scratch, and have <code>Vector</code>
as a first-class use case, I decided to bake in <code>ST</code>-like semantics to allow
directly playing around with mutable vectors. As a result, the type of <code>Peek</code>
has an extra state token parameter, just like <code>ST</code>:</p><pre><span class='hs-keyword'>newtype</span> <span class='hs-conid'>Peek</span> <span class='hs-varid'>s</span> <span class='hs-varid'>a</span></pre><p>Also, there is a <code>PrimMonad</code> instance for <code>Peek</code>, which allows for the mutable
vector operations to occur within the monad without any lifting. To see how
this works, take a look at the implementation of <code>simplePeek</code> for <code>Vector</code>s:</p><pre><span class='hs-definition'>simplePeek</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Simple</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Peek</span> <span class='hs-layout'>(</span><span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<span class='hs-definition'>simplePeek</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
    <span class='hs-varid'>len</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int64</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplePeek</span>
    <span class='hs-keyword'>let</span> <span class='hs-varid'>len'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>len</span>
    <span class='hs-varid'>mv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span> <span class='hs-varid'>len'</span>
    <span class='hs-keyword'>let</span> <span class='hs-varid'>loop</span> <span class='hs-varid'>i</span>
            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>len'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeFreeze</span> <span class='hs-varid'>mv</span>
            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
                <span class='hs-varid'>x</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplePeek</span>
                <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeWrite</span> <span class='hs-varid'>mv</span> <span class='hs-varid'>i</span> <span class='hs-varid'>x</span>
                <span class='hs-varid'>loop</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>i</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
    <span class='hs-varid'>loop</span> <span class='hs-num'>0</span></pre><p>All of this also applies to the <code>PeekEx</code> type.</p><h2 id="results">Results</h2><p>The <a href="https://s3.amazonaws.com/download.fpcomplete.com/michael/serial-bench-2016-03-13.html" rel="nofollow">criterion link I shared
above</a>
has the results of all of these benchmarks, but for the lazy, here&#39;s the result
graph again:</p><p><img src="https://s3.amazonaws.com/download.fpcomplete.com/michael/2bt7dns.png" alt="Benchmark results"></p><p>As you can see: the little-endian encoding regularly outperformed the other two
formats by a significant margin. This isn&#39;t surprising, given that there is
less CPU work that needs to be done, and that we are able to leverage primops
from GHC to do most of the work.</p><p>Similarly, while bytestring-builder is a very highly tuned library, for a
narrow use case like ours where the resulting buffer size is easily computed in
advance, constructing <code>ByteString</code>s manually gives a significant performance
boost.</p><p>To my surprise, the mutable reference/exception based approach to peeking and
poking was fairly competitive with the continuation-based approach.
Nonetheless, overall the continuation-based approach outperforms it, and is
more elegant an approach.</p><p>While the monadic and monoidal interfaces for poking/encoding give similar
results, the performance of the monoidal interface can be unpredictable if used
incorrectly. Since monadic combinators are more commonly optimized and more
ubiquitous, it&#39;s safer to expose the monadic interface. (And, for what it&#39;s
worth, we can always provide a <code>Monoid</code> instance for any <code>Monad</code>.)</p><p>And thankfully, the abstractions we use to make our encoding and decoding easy
to work with and nicely composable do not introduce a slowdown versus the
low-level implementation. So no need to force people to drop down to manual
continuation passing.</p><h2 id="what39s-next">What&#39;s next</h2><p>Based on this analysis, it seems like we have a clear set of choices for a new
serialization library. This blog post already clarifies the design goals of
such a library, and its limitations (e.g., no streaming decoding). Such a
library is something we&#39;ll almost certainly want to leverage for our
multi-machine computation work at FP Complete.</p><p>I&#39;m interested on feedback from others on this topic, including ways to better
optimize the code, alternative strategies, and additional use cases you might
have for such a library.</p></article>
</div>
<div class="col-md-4"><ul class="list-group"><li class="list-group-item"><b>December 2016</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/12/software-project-maintenance-is-where-haskell-shines" title="30 Dec 2016">Software project maintenance is where Haskell shines</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/12/concurrency-and-node" title=" 7 Dec 2016">Concurrency and Node</a>
</li>
<li class="list-group-item"><b>November 2016</b>
</li>
<li class="list-group-item"><a href="../11/comparison-scala-and-haskell.html" title="29 Nov 2016">Do you like Scala?  Give Haskell a try!</a>
</li>
<li class="list-group-item"><a href="../11/devops-best-practices-multifaceted-testing.html" title="28 Nov 2016">Devops best practices: Multifaceted Testing</a>
</li>
<li class="list-group-item"><a href="../11/scripting-in-haskell.html" title="22 Nov 2016">Scripting in Haskell</a>
</li>
<li class="list-group-item"><a href="../11/comparative-concurrency-with-haskell.html" title="22 Nov 2016">Comparative Concurrency with Haskell</a>
</li>
<li class="list-group-item"><a href="../11/mastering-time-to-market-haskell.html" title="21 Nov 2016">Mastering Time-to-Market with Haskell</a>
</li>
<li class="list-group-item"><a href="../11/devops-best-practices-immutability.html" title="13 Nov 2016">Devops best practices: Immutability</a>
</li>
<li class="list-group-item"><a href="../11/covariance-contravariance.html" title=" 9 Nov 2016">Covariance and Contravariance</a>
</li>
<li class="list-group-item"><a href="../11/exceptions-best-practices-haskell.html" title=" 7 Nov 2016">Exceptions Best Practices in Haskell</a>
</li>
<li class="list-group-item"><b>October 2016</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/10/static-compilation-with-stack" title=" 7 Oct 2016">Static compilation with Stack</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/10/docker-demons-pid1-orphans-zombies-signals" title=" 5 Oct 2016">Docker demons: PID-1, orphans, zombies, and signals</a>
</li>
<li class="list-group-item"><b>September 2016</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/09/updated-hackage-mirroring" title="27 Sep 2016">Updated Hackage mirroring</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/09/practical-haskell-simple-file-mirror-2" title="21 Sep 2016">Practical Haskell: Simple File Mirror (Part 2)</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/09/data-haskell" title="14 Sep 2016">Working with data in Haskell</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/09/practical-haskell-simple-file-mirror-1" title="14 Sep 2016">Practical Haskell: Simple File Mirror (Part 1)</a>
</li>
<li class="list-group-item"><b>August 2016</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/08/bitrot-free-scripts" title="11 Aug 2016">Practical Haskell: Bitrot-free Scripts</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/08/public-jenkins-server" title=" 1 Aug 2016">Announce: public Jenkins CI server</a>
</li>
<li class="list-group-item"><b>June 2016</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/06/announce-safe-exceptions" title="29 Jun 2016">Announce: safe-exceptions, for async exception safety</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/06/async-exceptions-stm-deadlocks" title="20 Jun 2016">async exceptions, STM, and deadlocks</a>
</li>
<li class="list-group-item"><b>May 2016</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/05/weigh-package" title="27 May 2016">weigh: Measuring allocations in Haskell</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/05/moving-stackage-nightly-ghc-8" title="26 May 2016">Moving Stackage Nightly to GHC 8.0</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/05/store-package" title="24 May 2016">store: a new and efficient binary serialization library</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/05/stack-security-gnupg-keys" title=" 5 May 2016">Stack Security GnuPG Keys</a>
</li>
<li class="list-group-item"><b>April 2016</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/04/stackage-data-flow" title="14 Apr 2016">The Stackage data flow</a>
</li>
<li class="list-group-item"><b>March 2016</b>
</li>
<li class="list-group-item"><a href="efficient-binary-serialization.html" title="14 Mar 2016">Efficient binary serialization</a>
</li>
<li class="list-group-item"><b>February 2016</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/02/testing-ghc-with-stackage" title="22 Feb 2016">Testing GHC with Stackage</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/02/updated-haskell-travis-config" title="17 Feb 2016">Updated Haskell Travis config</a>
</li>
<li class="list-group-item"><b>January 2016</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2016/01/soh-status" title=" 6 Jan 2016">Status of School of Haskell 2.0</a>
</li>
<li class="list-group-item"><b>December 2015</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/12/stack-travis" title="21 Dec 2015">Using Stack on Travis CI</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/12/docker-split-images" title="15 Dec 2015">The split-image approach to building minimal runtime Docker images</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/12/stack-with-ghc-7-10-3" title="11 Dec 2015">Using Stack with GHC 7.10.3</a>
</li>
<li class="list-group-item"><b>November 2015</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/11/kubernetes" title="19 Nov 2015">Kubernetes for Haskell Services</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/11/stack-stabilization" title=" 7 Nov 2015">Stack entering stabilization phase</a>
</li>
<li class="list-group-item"><b>October 2015</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/10/new-haskell-ide-repo" title="26 Oct 2015">The new haskell-ide repo</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/10/stackage-badges" title="19 Oct 2015">Stackage Badges</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/10/seeking-software-and-systems-engineers" title=" 7 Oct 2015">Seeking Software and Systems Engineers (Telecommute)</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/10/retiring-fphc" title=" 2 Oct 2015">Retiring FP Haskell Center</a>
</li>
<li class="list-group-item"><b>September 2015</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/09/stack-pvp" title="21 Sep 2015">stack and the PVP</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/09/stack-more-binary-package-sharing" title=" 1 Sep 2015">stack: more binary package sharing</a>
</li>
<li class="list-group-item"><b>August 2015</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/08/new-in-depth-guide-stack" title="31 Aug 2015">New in-depth guide to stack</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/08/stack-ghc-windows" title="24 Aug 2015">stack and GHC on Windows</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/08/stack-docker" title=" 5 Aug 2015">How stack can use Docker under the hood</a>
</li>
<li class="list-group-item"><b>July 2015</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/07/package-security-in-stack" title="20 Jul 2015">Package security in stack</a>
</li>
<li class="list-group-item"><b>June 2015</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/06/why-is-stack-not-cabal" title="24 Jun 2015">Why is stack not cabal?</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/06/stack-0-1-release" title="23 Jun 2015">stack 0.1 released</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/06/announcing-first-public-beta-stack" title=" 9 Jun 2015">ANNOUNCING: first public beta of stack</a>
</li>
<li class="list-group-item"><b>May 2015</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/05/thousand-user-haskell-survey" title="22 May 2015">What do Haskellers want? Over a thousand tell us</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/05/new-stackage-server" title="22 May 2015">The new Stackage Server</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/05/inline-c" title="20 May 2015">Call C functions from Haskell without bindings</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/05/psa-ghc-710-cabal-windows" title="19 May 2015">PSA: GHC 7.10, cabal, and Windows</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/05/distributing-packages-without-sysadmin" title="13 May 2015">Distributing our packages without a sysadmin</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/05/secure-package-distribution" title="11 May 2015">Secure package distribution: ready to roll</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/05/haskell-at-front-row" title=" 9 May 2015">Guest post: Haskell at Front Row</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/05/haskell-web-server-in-5mb" title=" 6 May 2015">Haskell Web Server in a 5MB Docker Image</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/05/school-of-haskell-2.0" title=" 4 May 2015">School of Haskell 2.0</a>
</li>
<li class="list-group-item"><b>April 2015</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/04/update-ghc-7-10-stackage" title="30 Apr 2015">Update on GHC 7.10 in Stackage</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/04/announcing-stackage-install" title="29 Apr 2015">Announcing: stackage-install</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/04/announcing-stackage-upload" title="28 Apr 2015">Announcing: stackage-upload</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/04/ghc-prof-flamegraph" title="27 Apr 2015">Flame graphs for GHC time profiles with ghc-prof-flamegraph</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/04/announcing-stackage-cli" title="20 Apr 2015">Announcing: first release of Stackage CLI (Command Line Tools)</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/04/future-of-soh-fphc" title="15 Apr 2015">The future of School of Haskell and FP Haskell Center</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/04/stackage-view" title="14 Apr 2015">Announcing: stackage-view</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/04/announcing-monad-unlift" title=" 8 Apr 2015">Announcing: monad-unlift</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/04/announcing-lts-2" title=" 2 Apr 2015">Announcing: LTS (Long Term Support) Haskell 2</a>
</li>
<li class="list-group-item"><b>March 2015</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/03/announce-ide-backend" title="30 Mar 2015">Announcing: open sourcing of ide-backend</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/03/minghc-ghc-7-10" title="27 Mar 2015">MinGHC for GHC 7.10</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/03/composable-community-infrastructure" title="26 Mar 2015">Our composable community infrastructure</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/03/hackage-mirror" title="25 Mar 2015">FP Complete&#39;s Hackage mirror</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/03/stackage-ghc-7-10" title="18 Mar 2015">Stackage and GHC 7.10 update</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/03/announcing-executable-hash" title="18 Mar 2015">Announcing executable-hash</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/03/upcoming-stackage-lts-2-0" title=" 9 Mar 2015">Upcoming Stackage LTS 2.0</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/03/hiring-systems-engineer" title=" 3 Mar 2015">Hiring: Systems Engineer</a>
</li>
<li class="list-group-item"><b>February 2015</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/02/primitive-haskell" title="17 Feb 2015">Primitive Haskell</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/02/Hiring-test-engineers" title=" 5 Feb 2015">FP Complete is Hiring Test Engineers</a>
</li>
<li class="list-group-item"><b>January 2015</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/01/commercial-haskell-sig" title="22 Jan 2015">Commercial Haskell Special Interest Group</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/01/fp-complete-software-pipeline" title="13 Jan 2015">FP Complete&#39;s software pipeline</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/01/hiring-software-engineer" title="13 Jan 2015">We&#39;re hiring: Software Engineer</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/01/announcing-mutable-containers-0-2" title=" 7 Jan 2015">Announcing: mutable-containers 0.2</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/01/fphc-release-3.2" title=" 6 Jan 2015">A New Release for the New Year: Announcing Release 3.2</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2015/01/announcing-lts-haskell-1-0" title=" 4 Jan 2015">Announcing LTS Haskell 1.0</a>
</li>
<li class="list-group-item"><b>December 2014</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/12/ghc-7-10-stackage-build" title="24 Dec 2014">GHC 7.10RC1 Stackage build results</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/12/stackage-survey-results" title="15 Dec 2014">Stackage: Survey results, easier usage, and LTS Haskell 0.X</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/12/dropping-ghc-74-support-fphc" title=" 8 Dec 2014">Dropping GHC 7.4 support in FP Haskell Center</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/12/backporting-bug-fixes" title=" 7 Dec 2014">Backporting bug fixes: Towards LTS Haskell</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/12/experimental-packages-stackage" title=" 1 Dec 2014">Experimental package releases via Stackage Server</a>
</li>
<li class="list-group-item"><b>November 2014</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/11/stackage-open-source" title="20 Nov 2014">Stackage server: new features and open source</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/11/seeking-haskell-dev-dist-hpc" title="13 Nov 2014">Seeking a Haskell developer for high performance, distributed computing</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/11/release-3.1" title=" 6 Nov 2014">3.1 release changes</a>
</li>
<li class="list-group-item"><b>October 2014</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/10/new-stackage-features" title="20 Oct 2014">New Stackage features</a>
</li>
<li class="list-group-item"><b>September 2014</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/09/hiring-haskell-web-ui-dev" title="11 Sep 2014">We&#39;re hiring: Haskell web UI developer</a>
</li>
<li class="list-group-item"><b>August 2014</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/08/conduit-stream-fusion" title="27 Aug 2014">IAP: conduit stream fusion</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/08/iap-speeding-up-conduit" title="21 Aug 2014">IAP: Speeding up conduit</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/08/announcing-stackage-server" title="14 Aug 2014">Announcing Stackage Server</a>
</li>
<li class="list-group-item"><b>July 2014</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/07/fphc-open-publish-announcement" title="31 Jul 2014">FP Haskell Center is Going Free</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/07/vectorbuilder-packed-conduit-yielding" title="30 Jul 2014">vectorBuilder: packed-representation yielding for conduit</a>
</li>
<li class="list-group-item"><b>May 2014</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/05/stackage-server" title="20 May 2014">Stackage Server</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/05/lenient-lower-bounds" title="12 May 2014">GHC 7.8, transformers 0.3, and lenient lower bounds</a>
</li>
<li class="list-group-item"><b>April 2014</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/04/heartbleed" title="14 Apr 2014">The heartbleed bug and FP Haskell Center</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/04/mvp" title=" 4 Apr 2014">Calculating the Minimum Variance Portfolio in R, Pandas and IAP</a>
</li>
<li class="list-group-item"><b>March 2014</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2014/03/monte-carlo-haskell" title="20 Mar 2014">Monte carlo analysis in Haskell</a>
</li>
<li class="list-group-item"><b>December 2013</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/12/api-emacs" title="18 Dec 2013">Emacs and our API</a>
</li>
<li class="list-group-item"><b>November 2013</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/11/call-for-entries" title="25 Nov 2013">Call For Entries</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/11/community-edition-announcement" title="18 Nov 2013">Announcing FP Haskell Center Community Edition and Feature Upgrades</a>
</li>
<li class="list-group-item"><b>September 2013</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/09/state-of-stackage" title="30 Sep 2013">The State of Stackage</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/09/august-competition-winners" title="17 Sep 2013">August Competition Winners</a>
</li>
<li class="list-group-item"><b>August 2013</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/08/webinar-announcement" title="28 Aug 2013">FP Haskell Center Launch Event</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/08/beta-discount-last-call" title="27 Aug 2013">4 Days Left to Get Beta User Discount</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/08/snap-happstack-anything-else" title=" 5 Aug 2013">Snap, Happstack and anything else</a>
</li>
<li class="list-group-item"><b>July 2013</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/07/academic-accounts" title="25 Jul 2013">FP Complete Announces Free Academic Accounts</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/07/beta-refresh-one" title="17 Jul 2013">FP Haskell Center Beta Refresh</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/07/ide-stackage" title="17 Jul 2013">IDE and Stackage</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/07/competition-announcement" title="16 Jul 2013">FP Complete Launches FP Haskell Competition with $1,000 Cash Prize Each Month</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/07/beta-activation-update" title=" 5 Jul 2013">FP Haskell Center Beta Sign-Up Still Open. Scheduled Activations Ongoing</a>
</li>
<li class="list-group-item"><b>June 2013</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/06/fp-haskell-center-beta-announcement" title="30 Jun 2013">FP Haskell Center Beta Released, and Beta Accounts Activated</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/06/fp-haskell-center-beta-demo" title="27 Jun 2013">FP Haskell Center Beta Demo</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/06/fp-haskell-center-video-blog" title="24 Jun 2013">FP Haskell Center Video Blog</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/06/beta-sign-up" title="17 Jun 2013">FP Haskell Center Beta Sign-Up</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/06/interim-web-site" title="17 Jun 2013">Interim Web Site</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/06/call-for-submissions" title=" 7 Jun 2013">FP Complete Launches Haskell in Real World Competition</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/06/haskell-from-c" title=" 2 Jun 2013">Haskell from C: Where are the for Loops?</a>
</li>
<li class="list-group-item"><b>March 2013</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/03/learning-through-koans" title="19 Mar 2013">Learning Haskell Through Koans</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/03/SoH-Goes-Public" title=" 4 Mar 2013">School of Haskell Goes Public</a>
</li>
<li class="list-group-item"><b>February 2013</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/02/announcing-case-studies" title="17 Feb 2013">Case studies of commercial Haskell use</a>
</li>
<li class="list-group-item"><b>January 2013</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/01/school-of-haskell-goes-beta" title="31 Jan 2013">School of Haskell Goes Beta</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/01/joining-fp-complete" title="21 Jan 2013">Joining FP Complete</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2013/01/why-im-investing-in-fp-complete" title=" 3 Jan 2013">Why I&#39;m investing in FP Complete</a>
</li>
<li class="list-group-item"><b>December 2012</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2012/12/solving_the_software_crisis" title="17 Dec 2012">Solving the Global Software Crisis</a>
</li>
<li class="list-group-item"><b>November 2012</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2012/11/designing-the-haskell-ide" title="19 Nov 2012">Designing the Haskell IDE</a>
</li>
<li class="list-group-item"><b>October 2012</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2012/10/yesod-tutorial-2-playing-with-routes-and-links" title="17 Oct 2012">Yesod Tutorial 2. Playing with Routes and Links</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2012/10/yesod-tutorial-1-my-first-web-site" title=" 1 Oct 2012">Yesod Tutorial 1. My First Web Site</a>
</li>
<li class="list-group-item"><b>September 2012</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2012/09/commercialuserneeds" title="27 Sep 2012">What do commercial users want from Haskell?</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2012/09/functional-patterns-in-c" title="24 Sep 2012">Functional Patterns in C++</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2012/09/ten-things-you-should-know-about-haskell-syntax" title=" 5 Sep 2012">Ten Things You Should Know About Haskell Syntax</a>
</li>
<li class="list-group-item"><b>August 2012</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2012/08/5-day-haskell-course" title="22 Aug 2012">5-Day Haskell Course</a>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2012/08/joining-forces-to-advance-haskell" title="13 Aug 2012">Joining forces to advance Haskell </a>
</li>
<li class="list-group-item"><b>July 2012</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2012/07/the-functor-pattern-in-c" title="16 Jul 2012">The Functor Pattern in C++</a>
</li>
<li class="list-group-item"><b>June 2012</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2012/06/asynchronous-api-in-c-and-the-continuation-monad" title="20 Jun 2012">Asynchronous API in C++ and the Continuation Monad</a>
</li>
<li class="list-group-item"><b>April 2012</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2012/04/the-downfall-of-imperative-programming" title=" 9 Apr 2012">The Downfall of Imperative Programming</a>
</li>
<li class="list-group-item"><b>March 2012</b>
</li>
<li class="list-group-item"><a href="https://www.fpcomplete.com/blog/2012/03/onamission" title=" 9 Mar 2012">It&#39;s time for Functional Programming</a>
</li>
</ul>
</div>
</div>
<div class="row"><div class="col-md-12"><div id="disqus_thread"><script>var disqus_shortname = 'fpcomplete'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })();</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a class="dsq-brlink" href="https://disqus.com/">comments powered by <span class="logo-disqus">Disqus</span></a></a>
</div>
</div>
</div>
</div>
<div class="container"><div class="row"><div class="col-md-2"></div>
<div class="col-md-8"><div id="social"><div class="twitter-share"><a class="twitter-share-button" href="https://twitter.com/share" data-show-count="false">Tweet</a>
</div>
<div class="reddit"><script type="text/javascript" src="http://www.redditstatic.com/button/button1.js"></script>
</div>
<div class="linkedin"><script src="http://platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<script type="IN/Share" data-counter="right"></script>
</div>
<div class="googleplus"><script src="https://apis.google.com/js/platform.js" async defer></script>
<g:plusone></g:plusone>
</div>
</div>
</div>
</div>
</div>

<div class="container"><div class="row"><div class="col-md-12"><hr>
<footer class="text-center">Copyright &copy; 2013-2016 FP Complete Corp. All rights reserved</footer>
<ul class="nav navbar-nav"><li><a href="https://www.fpcomplete.com/pages">Sitemap</a>
</li>
<li><a href="https://www.fpcomplete.com/about-us">About Us</a>
</li>
<li><a href="https://www.fpcomplete.com/jobs">Jobs</a>
</li>
</ul>
</div>
</div>
<div class="row"><div class="col-md-12"><div id="twitter"><div class="follow"><a class="twitter-follow-button" href="https://twitter.com/fpcomplete" data-show-count="false">Follow @fpcomplete</a>
</div>
<div class="mention"><a class="twitter-mention-button" href="https://twitter.com/intent/tweet?screen_name=fpcomplete" data-show-count="false">Tweet to @fpcomplete</a>
<script async src="http://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
</div>
</div>
</div>
</div>
<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create', 'UA-36928035-3', 'auto');ga('send', 'pageview');</script></body>
<!-- Mirrored from www.fpcomplete.com/blog/2016/03/efficient-binary-serialization by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 31 Dec 2016 04:42:17 GMT -->
</html>